<!DOCTYPE html>
<html>
<head>
  <title>Stagee POC</title>
  <style>
    body {font-family:sans-serif; margin:2em;}
    textarea {width:100%; height:100px;}
    .student, .offers {margin-top:1em;}
    .offer {border:1px solid #ccc; padding:0.5em; margin:0.5em 0;}
    .matched {color: green; font-weight: bold;}
    .progress-container {background:#eee; width:100%; height:12px; border-radius:6px;}
    .progress-bar {background:#4caf50; height:100%; border-radius:6px;}
    input[type=text] {width:100%; padding:4px; margin:2px 0;}
    button {margin-top:5px;}
  </style>
</head>
<body>
<h2>Paste CV Text</h2>
<form method="post">
  <textarea name="cvtext" placeholder="Paste your CV text here..."></textarea><br>
  <button type="submit">Extract & Recommend</button>
</form>

{% if student %}
<div class="student">
  <h3>Extracted Profile</h3>
  <form id="editProfileForm">
    <label>Name:</label>
    <input type="text" name="name" value="{{ student.name or '' }}"><br>
    <label>Email:</label>
    <input type="text" name="email" value="{{ student.email or '' }}"><br>
    <label>Skills:</label>
    <input type="text" name="skills" value="{{ (student.skills or [])|join(', ') }}"><br>
    <button type="button" onclick="updateRecommendations()">Update Recommendations</button>
  </form>
</div>

<div class="offers">
  <h3>Top Recommended Offers</h3>
  <div id="recommendations">
    {% for rec in recommendations %}
      <div class="offer">
        <b>{{ rec.offer.title }}</b><br>
        Matched Skills:
        {% for skill in rec.offer.skills %}
          {% if skill in student.skills %}
            <span class="matched">{{ skill }}</span>
          {% else %}
            {{ skill }}
          {% endif %}
          {% if not loop.last %}, {% endif %}
        {% endfor %}
        <br>
        Match Score: {{ rec.score }}
        <div class="progress-container">
          <div class="progress-bar" style="width:{{ (rec.score*33 if rec.score < 3 else 100) }}%"></div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<script>
function updateRecommendations(){
    const form = document.getElementById("editProfileForm");
    const name = form.name.value;
    const email = form.email.value;
    const skills = form.skills.value.split(",").map(s=>s.trim()).filter(s=>s);

    fetch("/tools/offers-search", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            name: name,
            email: email,
            skills: skills,
            embedding: [] // ignored when USE_EMBEDDINGS=0
        })
    }).then(res=>res.json())
    .then(data=>{
        const container = document.getElementById("recommendations");
        container.innerHTML = "";
        data.forEach(rec=>{
            let matchedSkills = rec.offer.skills.map(s=>{
                return skills.includes(s) ? `<span class="matched">${s}</span>` : s;
            }).join(", ");
            let barWidth = Math.min(rec.score * 33, 100); // scale & cap
            container.innerHTML += `<div class="offer">
                <b>${rec.offer.title}</b><br>
                Matched Skills: ${matchedSkills}<br>
                Match Score: ${rec.score}
                <div class="progress-container">
                  <div class="progress-bar" style="width:${barWidth}%"></div>
                </div>
            </div>`;
        });
    });
}
</script>
</body>
</html>
